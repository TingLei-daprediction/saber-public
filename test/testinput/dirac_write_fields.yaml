geometry:
  function space: NodeColumns
  grid:
    name: CS-LFR-15
  partitioner: cubedsphere
  groups:
  - variables:
    - air_pressure
    - air_pressure_levels_minus_one
    - air_temperature
    - cfeff
    - cleff
    - cloud_ice_mixing_ratio_wrt_moist_air_and_condensed_water
    - cloud_liquid_water_mixing_ratio_wrt_moist_air_and_condensed_water
    - dlsvpdT
    - dry_air_density_levels_minus_one
    - eastward_wind
    - dimensionless_exner_function
    - dimensionless_exner_function_levels_minus_one
    - geostrophic_pressure_levels_minus_one
    - height_above_mean_sea_level
    - ice_cloud_volume_fraction_in_atmosphere_layer
    - liquid_cloud_volume_fraction_in_atmosphere_layer
    - mu
    - muA
    - muH1
    - muRecipDeterminant
    - muRow1Column1
    - muRow1Column2
    - muRow2Column1
    - muRow2Column2
    - cloud_ice_mixing_ratio_wrt_dry_air
    - cloud_liquid_water_mixing_ratio_wrt_dry_air
    - rain_mixing_ratio_wrt_dry_air
    - total_water_mixing_ratio_wrt_dry_air
    - water_vapor_mixing_ratio_wrt_dry_air
    - northward_wind
    - air_potential_temperature
    - qrain
    - qsat
    - qt
    - rht
    - water_vapor_mixing_ratio_wrt_moist_air_and_condensed_water
    - air_horizontal_streamfunction
    - svp
    - unbalanced_pressure_levels_minus_one
    - air_horizontal_velocity_potential
    - virtual_potential_temperature
    levels: 70
  - variables:
    - air_pressure_levels
    - height_above_mean_sea_level_levels
    - hydrostatic_exner_levels
    - hydrostatic_pressure_levels
    levels: 71
  halo: 1

background:
  date: 2016-01-01T16:00:00Z
  state variables:
  - air_pressure
  - air_pressure_levels_minus_one
  - eastward_wind
  - dimensionless_exner_function
  - dimensionless_exner_function_levels_minus_one
  - height_above_mean_sea_level
  - height_above_mean_sea_level_levels
  - ice_cloud_volume_fraction_in_atmosphere_layer
  - liquid_cloud_volume_fraction_in_atmosphere_layer
  - cloud_ice_mixing_ratio_wrt_dry_air
  - cloud_liquid_water_mixing_ratio_wrt_dry_air
  - rain_mixing_ratio_wrt_dry_air
  - water_vapor_mixing_ratio_wrt_dry_air
  - northward_wind
  - air_potential_temperature
  filepath: testdata/gauss_state

increment variables:
- dry_air_density_levels_minus_one
- eastward_wind
- dimensionless_exner_function_levels_minus_one
- northward_wind
- air_potential_temperature
- cloud_ice_mixing_ratio_wrt_moist_air_and_condensed_water
- cloud_liquid_water_mixing_ratio_wrt_moist_air_and_condensed_water
- water_vapor_mixing_ratio_wrt_moist_air_and_condensed_water

background error:
  covariance model: SABER
  inverse test: true
  inverse tolerance: 1e-15
  saber central block:
    saber block name: spectral covariance
    active variables:
    - mu
    - air_horizontal_streamfunction
    - unbalanced_pressure_levels_minus_one
    - air_horizontal_velocity_potential
    read:
      covariance_file: testdata/spectralcov.nc
      umatrix_netcdf_names:
      - MU_inc_Uv_matrix
      - PSI_inc_Uv_matrix
      - aP_inc_Uv_matrix
      - CHI_inc_Uv_matrix
  saber outer blocks:
  # Write out fields in spectral space
  - saber block name: write fields
    output path: testdata/dirac_write_fields
    xb filename: fields_Spectral_space_final_xb
    fg filename: fields_Spectral_space_final_fg
    save netCDF file: False
    save GMSH file: true
    field names:
    - eastward_wind
    - northward_wind
    skip inverse: true
  - saber block name: spectral to gauss
    inner inverse tolerance: 1e-12
    outer inverse tolerance: 1e-8
    active variables:
    - eastward_wind
    - mu
    - northward_wind
    - air_horizontal_streamfunction
    - unbalanced_pressure_levels_minus_one
    - air_horizontal_velocity_potential
  - saber block name: gauss winds to geostrophic pressure
    skip inverse test: true  # Tested within mo_hydrostatic_pressure block
  # Write out fields in Gaussian space
  - saber block name: write fields
    output path: testdata/dirac_write_fields
    multiply fset filename: fields_Gaussian_space_multiply
    multiplyad fset filename: fields_Gaussian_space_multiplyad
    left inverse fset filename: fields_Gaussian_space_leftinverse
    field names:
    - eastward_wind
    - northward_wind
    skip inverse: true
    save GMSH file: true
  - saber block name: gauss to cubed-sphere-dual
    inner inverse tolerance: 0.2
    outer inverse tolerance: 0.2
    gauss grid uid: F15
    interpolation type: "structured-bicubic"
    active variables:
    - eastward_wind
    - mu
    - northward_wind
    - geostrophic_pressure_levels_minus_one
  # Write out fields in cubed-sphere space
  - saber block name: write fields
    output path: testdata/dirac_write_fields
    multiply fset filename: inner_fields_CS_space_multiply
    multiplyad fset filename: inner_fields_CS_space_multiplyad
    left inverse fset filename: inner_fields_CS_space_leftinverse
    field names:
     - geostrophic_pressure_levels_minus_one
     - mu
  - saber block name: mo_hydrostatic_pressure_from_geostrophic_pressure
    skip inverse test: true  # Tested within mo_hydrostatic_pressure block
    read:
      covariance file path: testdata/FPstats.nc
      number of covariance latitude rings: 481
      gp regression bins: 18
  - saber block name: mo_hydrostatic_pressure_to_hydrostatic_exner
    saturation vapour pressure file: testdata/svp_dlsvp_svpW_dlsvpW.nc
    skip inverse test: true
  - saber block name: mo_hydro_bal
    skip inverse test: true
    inner inverse tolerance: 1e-9  #TODO to be replaced by relative tolerance
    outer variables to compare: [virtual_potential_temperature, air_pressure_levels_minus_one]
    outer inverse tolerance: 1e-13
  - saber block name: mo_hydrostatic_pressure_hydrostatic_exner_to_pressure_exner
    inner variables to compare:
    - hydrostatic_exner_levels
    - hydrostatic_pressure_levels
    outer variables to compare:
    - air_pressure_levels
    - dimensionless_exner_function_levels_minus_one
  - saber block name: mo_moisture_control
    inner inverse tolerance: 1e-13
    outer inverse tolerance: 1e-4  #TODO to be replaced by relative tolerance
    inner variables to compare:
      - mu
      - virtual_potential_temperature
    read:
      covariance file path: testdata/MUstats.nc
  - saber block name: mo_air_temperature
    skip inverse test: true
  - saber block name: mo_moistincrop
    skip inverse test: true  # Tested within the mo_super_mio block
    inner variables to compare: [qt, air_temperature]
    moisture incrementing operator file: testdata/MIO_coefficients.nc
  - saber block name: mo_dry_air_density
    skip inverse test: true
  # Write out fields in cubed-sphere space
  - saber block name: write fields
    output path: testdata/dirac_write_fields
    xb filename: outer_fields_CS_space_xb
    fg filename: outer_fields_CS_space_fg
    multiply fset filename: outer_fields_CS_space_multiply
    multiplyad fset filename: outer_fields_CS_space_multiplyad
    left inverse fset filename: outer_fields_CS_space_leftinverse
    save netCDF file: false
    save GMSH file: true
    field names:
    - dry_air_density_levels_minus_one

test:
  test output filename: testref/dirac_write_fields.out
  reference filename: testref/dirac_write_fields.ref
