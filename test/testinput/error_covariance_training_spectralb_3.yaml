# The idea of this test is to read ensemble perturbations generated via the
# the randomize method and generate spectral vertical covariances and
# variances / vertical covariances in grid point space.
# These spectral vertical covariances should be similar to the original
# spectral vertical covariances used by the randomization method.
geometry:
  function space: StructuredColumns
  grid:
    type: regular_gaussian
    N: 12
  groups:
  - variables:
    - air_horizontal_streamfunction
    - air_horizontal_velocity_potential
    - air_potential_temperature
    - air_pressure
    - air_pressure_levels_minus_one
    - cfeff
    - cleff
    - cloud_ice_mixing_ratio_wrt_dry_air
    - cloud_ice_mixing_ratio_wrt_moist_air_and_condensed_water
    - cloud_liquid_water_mixing_ratio_wrt_dry_air
    - cloud_liquid_water_mixing_ratio_wrt_moist_air_and_condensed_water
    - dimensionless_exner_function
    - dimensionless_exner_function_levels_minus_one
    - dlsvpdT
    - dry_air_density_levels_minus_one
    - eastward_wind
    - geostrophic_pressure_levels_minus_one
    - height_above_mean_sea_level
    - hydrostatic_pressure_levels_minus_one
    - ice_cloud_volume_fraction_in_atmosphere_layer
    - liquid_cloud_volume_fraction_in_atmosphere_layer
    - qrain
    - qsat
    - qt
    - rht
    - svp
    - mu
    - muA
    - muH1
    - muRecipDeterminant
    - muRow1Column1
    - muRow1Column2
    - muRow2Column1
    - muRow2Column2
    - northward_wind
    - rain_mixing_ratio_wrt_dry_air
    - total_water_mixing_ratio_wrt_dry_air
    - unbalanced_pressure_levels_minus_one
    - virtual_potential_temperature
    - water_vapor_mixing_ratio_wrt_dry_air
    - water_vapor_mixing_ratio_wrt_moist_air_and_condensed_water
    levels: 70
  - variables:
    - air_pressure_levels
    - height_above_mean_sea_level_levels
    - hydrostatic_exner_levels
    - hydrostatic_pressure_levels
    levels: 71
  partitioner: ectrans
  halo: 1

background:
  date: 2010-01-01T12:00:00Z
  state variables: &statevars
  - air_potential_temperature
  - air_pressure
  - air_pressure_levels_minus_one
  - cloud_ice_mixing_ratio_wrt_dry_air
  - cloud_liquid_water_mixing_ratio_wrt_dry_air
  - dimensionless_exner_function
  - dimensionless_exner_function_levels_minus_one
  - dry_air_density_levels_minus_one
  - height_above_mean_sea_level
  - height_above_mean_sea_level_levels
  - ice_cloud_volume_fraction_in_atmosphere_layer
  - liquid_cloud_volume_fraction_in_atmosphere_layer
  - rain_mixing_ratio_wrt_dry_air
  - water_vapor_mixing_ratio_wrt_dry_air
  filepath: testdata/gauss_state

increment variables: &incrvars
- air_potential_temperature
- cloud_ice_mixing_ratio_wrt_moist_air_and_condensed_water
- cloud_liquid_water_mixing_ratio_wrt_moist_air_and_condensed_water
- dimensionless_exner_function_levels_minus_one
- dry_air_density_levels_minus_one
- eastward_wind
- northward_wind
- water_vapor_mixing_ratio_wrt_moist_air_and_condensed_water

background error:
  covariance model: SABER
  ensemble pert:
    date: 2010-01-01T12:00:00Z
    members from template:
      template:
        date: 2010-01-01T12:00:00Z
        filepath: testdata/randomization_sqrtspectralb_4/randomized_gauss_mb%mem%
      pattern: '%mem%'
      nmembers: 2
  saber central block:
    saber block name: spectral covariance
    active variables:   
    - air_horizontal_streamfunction
    - air_horizontal_velocity_potential
    - mu
    - unbalanced_pressure_levels_minus_one
    calibration:
      write:
        covariance name: "specvertcov3"
        mpi pattern: '%MPI%'
        file path: testdata/error_covariance_training_spectralb_3/spectralvertcov_%MPI%.nc
  saber outer blocks:
  - saber block name: spectral to gauss
    calibration: true
    active variables:
    - air_horizontal_streamfunction
    - air_horizontal_velocity_potential
    - eastward_wind
    - mu
    - northward_wind
    - unbalanced_pressure_levels_minus_one
  - saber block name: write variances
    additional cross covariances:
    - variable 1: eastward_wind
      variable 2: mu
    - variable 1: eastward_wind
      variable 2: northward_wind
    - variable 1: eastward_wind
      variable 2: unbalanced_pressure_levels_minus_one
    - variable 1: mu
      variable 2: northward_wind
    - variable 1: mu
      variable 2: unbalanced_pressure_levels_minus_one
    - variable 1: northward_wind
      variable 2: unbalanced_pressure_levels_minus_one
    binning:
      type: "horizontal global average"
      mpi rank pattern: '%MPI%'
      file path: testdata/error_covariance_training_spectralb_3/hor_glo_ave_%MPI%.nc
    calibration:
      write:
        covariance name: "controlvariables"
        mpi pattern: '%MPI%'
        file path: testdata/error_covariance_training_spectralb_3/cntlvertcov_%MPI%.nc
    field names:
    - eastward_wind
    - mu
    - northward_wind
    - unbalanced_pressure_levels_minus_one
    save NetCDF file: true
    statistics type:  "vertical covariance"
  - saber block name: mo_hydrostatic_pressure_levels_minus_one
    calibration read:
      covariance file path: testdata/FPstats.nc
      number of covariance latitude rings: 481
      gp regression bins: 18
    calibration: true
  - saber block name: mo_hp_lvlsm1_to_hexner_lvls
    calibration: true
  - saber block name: mo_hydro_bal2
    calibration: true
  - saber block name: mo_moisture_control
    calibration:
      read:
        covariance file path: testdata/MUstats.nc
  - saber block name: mo_super_mio
    moisture incrementing operator file: testdata/MIO_coefficients.nc
    calibration:
      coefficient filling value: median
      output file: testdata/error_covariance_training_spectralb_3/MIO_coefficients_new.nc
  - saber block name: mo_dry_air_density_from_exnerm1
    calibration: true
  - saber block name: write variances
    binning:
      type: "horizontal global average"
      mpi rank pattern: '%MPI%'
      file path: testdata/error_covariance_training_spectralb_3/hor_glo_ave_%MPI%.nc
    calibration:
      write:
        covariance name: "model_variables"
        mpi pattern: '%MPI%'
        file path: testdata/error_covariance_training_spectralb_3/model_vertcov_%MPI%.nc
    field names: *incrvars
    save NetCDF file: true
    statistics type:  "vertical covariance"
test:
  reference filename: testref/error_covariance_training_spectralb_3.ref
